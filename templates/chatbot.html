{% extends "base.html" %}

{% block title %}Chatbot IA - Sabores y Raíces{% endblock %}

{% block content %}
<div class="container main-content">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="auth-card p-4">
                <div class="text-center mb-4">
                    <h2 class="fw-bold">Chatbot IA</h2>
                    <p class="text-muted">Habla con nuestro asistente para reservas y recomendaciones</p>
                </div>
                
                <div id="chat-container" class="border rounded p-3 mb-3" style="height: 400px; overflow-y: auto; background: #f8f9fa;">
                    <div id="chat-messages">
                        <div class="message bot-message mb-2">
                            <strong>Bot:</strong> ¡Hola! Soy el asistente IA de Sabores y Raíces. ¿En qué puedo ayudarte hoy? Puedes preguntar sobre reservas, menú, o hacer una nueva reserva.
                        </div>
                    </div>
                </div>
                
                <div class="input-group">
                    <input type="text" id="message-input" class="form-control" placeholder="Escribe tu mensaje...">
                    <button id="send-button" class="btn btn-primary" type="button">
                        <i class="fas fa-paper-plane"></i> Enviar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const messagesContainer = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');

    function addMessage(content, isBot = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = isBot ? 'message bot-message mb-2' : 'message user-message mb-2';
        messageDiv.innerHTML = `<strong>${isBot ? 'Bot' : 'Tú'}:</strong> ${content}`;
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    sendButton.addEventListener('click', function() {
        const message = messageInput.value.trim();
        if (message) {
            addMessage(message);
            messageInput.value = '';

            fetch('/chatbot/converse', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({message: message})
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(text => {
                try {
                    const data = JSON.parse(text);
                    if (data && data.response !== undefined && data.response !== null && data.response !== '') {
                        addMessage(data.response, true);
                    } else if (data && data.error) {
                        addMessage(data.error, true);
                    } else {
                        addMessage('Respuesta vacía del servidor. Intenta de nuevo.', true);
                    }
                } catch (parseError) {
                    console.error('JSON parse error:', parseError, 'Response text:', text);
                    addMessage('Error al procesar la respuesta del servidor (formato inválido).', true);
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                addMessage('Error de conexión con el servidor. Verifica que la aplicación esté ejecutándose.', true);
            });
        }
    });

    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendButton.click();
        }
    });
});
</script>
{% endblock %}
